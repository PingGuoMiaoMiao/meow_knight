// Copyright 2025 International Digital Economy Academy
//
// Licensed under the Apache License, Version 2.0 (the "License");
// you may not use this file except in compliance with the License.
// You may obtain a copy of the License at
//
//     http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing, software
// distributed under the License is distributed on an "AS IS" BASIS,
// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
// See the License for the specific language governing permissions and
// limitations under the License.

// ç®€åŒ–çš„UIç³»ç»Ÿ - ä¸ä½¿ç”¨@uiæ¨¡å—ï¼Œç›´æ¥ç”¨spriteæ˜¾ç¤º

///| UIå±‚çº§å¸¸é‡
const UI_Z : Int = 1000

///| å¯¹è¯é˜Ÿåˆ—é¡¹
struct DialogueItem {
  name : String
  text : String
  avatar : @sprite.Animation?
}

///| å¯¹è¯é˜Ÿåˆ—å’Œå½“å‰ç´¢å¼•
let dialogue_queue : Array[DialogueItem] = []
struct DialogueState {
  mut current_index : Int
  mut has_queue : Bool
}
let dialogue_state : DialogueState = { current_index: 0, has_queue: false }

///| UIå®ä½“å­˜å‚¨ç»“æ„
struct UIEntities {
  mut score_entity : @system.Entity
  mut health_entity : @system.Entity
}

///| å…¨å±€UIå®ä½“å­˜å‚¨
let ui_entities : UIEntities = {
  score_entity: @system.Entity::new(),
  health_entity: @system.Entity::new(),
}

///| æ£€æŸ¥é¼ æ ‡æ˜¯å¦åœ¨å…³é—­æŒ‰é’®èŒƒå›´å†…ï¼ˆå·²åºŸå¼ƒï¼Œç°åœ¨ä½¿ç”¨ç©ºæ ¼é”®å…³é—­ï¼‰
pub fn is_mouse_on_close_button() -> Bool {
  false  // ä¸å†ä½¿ç”¨é¼ æ ‡å…³é—­
}

///| æ·»åŠ åˆ†æ•°æ˜¾ç¤º
pub fn add_score_box() -> Unit {
  let entity = @system.Entity::new()
  @position.positions.set(entity, @math.Vec2D(World_Width / 2.0 - 50, 20))
  let text_sprite = @sprite.Sprite::from_text(
    @sprite.Text::new("Score: 0", font="20px ThaleahFat", color="#FFFFFF"),
    UI_Z,
  )
  @sprite.sprites.set(entity, text_sprite)
  ui_entities.score_entity = entity
}

///| æ·»åŠ è¡€é‡æ˜¾ç¤º
pub fn add_health_box() -> Unit {
  let entity = @system.Entity::new()
  @position.positions.set(entity, @math.Vec2D(20, 20))
  let text_sprite = @sprite.Sprite::from_text(
    @sprite.Text::new("HP: 3", font="20px ThaleahFat", color="#FFFFFF"),
    UI_Z,
  )
  @sprite.sprites.set(entity, text_sprite)
  ui_entities.health_entity = entity
}

///| æ›´æ–°åˆ†æ•°æ˜¾ç¤º
pub fn update_score(score : Int) -> Unit {
  let entity = ui_entities.score_entity
  if entity.is_alive() {
    let text_sprite = @sprite.Sprite::from_text(
      @sprite.Text::new("Score: " + score.to_string(), font="20px ThaleahFat", color="#FFFFFF"),
      UI_Z,
    )
    @sprite.sprites.set(entity, text_sprite)
  }
}

///| æ›´æ–°è¡€é‡æ˜¾ç¤º
pub fn update_health(health : Int) -> Unit {
  let entity = ui_entities.health_entity
  if entity.is_alive() {
    let text_sprite = @sprite.Sprite::from_text(
      @sprite.Text::new("HP: " + health.to_string(), font="20px ThaleahFat", color="#FFFFFF"),
      UI_Z,
    )
    @sprite.sprites.set(entity, text_sprite)
  }
}

///| æ·»åŠ éŸ³é‡æŒ‰é’®ï¼ˆç®€åŒ–å®ç°ï¼‰
pub fn add_volume_button() -> Unit {
  // ç®€åŒ–å®ç°ï¼Œæš‚æ—¶ä¸æ·»åŠ æŒ‰é’®
  ()
}

///| å¯¹è¯å®ä½“å­˜å‚¨
let dialogue_entities : Array[@system.Entity] = []

///| æ£€æŸ¥å¯¹è¯æ¡†æ˜¯å¦æ­£åœ¨æ˜¾ç¤º
pub fn is_dialogue_showing() -> Bool {
  dialogue_entities.length() > 0
}

///| æ˜¾ç¤ºslimeæ­»äº¡å¯¹è¯åºåˆ—ï¼ˆå²è±å§†è¯´å®Œåï¼Œç©å®¶è¯´è¯ï¼‰
pub fn show_slime_death_dialogue() -> Unit {
  // æ¸…ç©ºé˜Ÿåˆ—
  dialogue_queue.clear()
  dialogue_state.current_index = 0
  dialogue_state.has_queue = true
  
  // æ·»åŠ å¯¹è¯åˆ°é˜Ÿåˆ—
  dialogue_queue.push(DialogueItem::{ 
    name: "å²è±å§†", 
    text: "å’•å™œå’•å™œ...", 
    avatar: Some(silme_idle_animation) 
  })
  dialogue_queue.push(DialogueItem::{ 
    name: "ç©å®¶", 
    text: "ä»€ä¹ˆä¸œè¥¿è¢«ç¢¾æ­»äº†...", 
    avatar: None 
  })
  
  // æ˜¾ç¤ºç¬¬ä¸€æ®µå¯¹è¯
  show_next_dialogue()
}

///| æ˜¾ç¤ºé˜Ÿåˆ—ä¸­çš„ä¸‹ä¸€æ®µå¯¹è¯
pub fn show_next_dialogue() -> Unit {
  if dialogue_state.current_index < dialogue_queue.length() {
    let item = dialogue_queue[dialogue_state.current_index]
    dialogue_state.current_index = dialogue_state.current_index + 1
    show_dialogue(item.name, item.text, item.avatar)
    
    // å¦‚æœå·²ç»æ˜¾ç¤ºå®Œæ‰€æœ‰å¯¹è¯ï¼Œæ¸…ç©ºé˜Ÿåˆ—çŠ¶æ€
    if dialogue_state.current_index >= dialogue_queue.length() {
      dialogue_state.has_queue = false
    }
  } else {
    // é˜Ÿåˆ—ç»“æŸ
    dialogue_state.has_queue = false
    dialogue_state.current_index = 0
    dialogue_queue.clear()
  }
}

///| æ£€æŸ¥æ˜¯å¦è¿˜æœ‰å¯¹è¯é˜Ÿåˆ—
pub fn has_dialogue_queue() -> Bool {
  dialogue_state.has_queue
}

///| æ¸…é™¤å¯¹è¯
pub fn clear_dialogue() -> Unit {
  dialogue_entities.iter().each(fn(entity) {
    @system.Entity::destroy(entity)
  })
  dialogue_entities.clear()
}

///| é€šç”¨å¯¹è¯æ˜¾ç¤ºå‡½æ•°
///| name: è§’è‰²åå­—ï¼ˆä¾‹å¦‚ï¼š"å²è±å§†"ã€"å°çŒ«"ã€"ç²¾çµ"ï¼‰
///| text: å¯¹è¯å†…å®¹ï¼ˆä¾‹å¦‚ï¼š"ä½ å¥½ï¼Œå‹‡å£«ï¼"ï¼‰
///| avatar_animation: è§’è‰²å¤´åƒåŠ¨ç”»ï¼ˆå¯é€‰ï¼Œä¼  None åˆ™ä¸æ˜¾ç¤ºå¤´åƒï¼‰
pub fn show_dialogue(name : String, text : String, avatar_animation : @sprite.Animation?) -> Unit {
  clear_dialogue()
  println("ğŸ¬ æ˜¾ç¤ºå¯¹è¯ï¼š[\{name}] \{text}")

  // è·å–ç©å®¶ä½ç½®
  let player_pos = @position.positions.get(game_state.player).unwrap_or(@math.Vec2D(250.0, 300.0))
  println("ğŸ“ ç©å®¶ä½ç½®: (\{player_pos.0[X]}, \{player_pos.0[Y]})")
  
  // å¯¹è¯æ¡†æ˜¾ç¤ºåœ¨ç©å®¶å³ä¾§ï¼š
  // X: ç©å®¶å³ä¾§65åƒç´ ï¼ˆç©å®¶å®½åº¦çº¦32ï¼Œç•™ç‚¹é—´è·ï¼‰
  // Y: ä¸ç©å®¶åŒé«˜åº¦
  let base_x = player_pos.0[X] + 65.0  // æ˜¾ç¤ºåœ¨ç©å®¶å³ä¾§
  let base_y = player_pos.0[Y] + 25.0  // å†å¾€ä¸‹ä¸€ç‚¹
  
  println("ğŸ’¬ å¯¹è¯æ¡†ä½ç½®: (\{base_x}, \{base_y})")

  // é¡¶éƒ¨è¾¹æ¡†ï¼ˆç¼©çŸ­ï¼‰
  let top_entity = @system.Entity::new()
  @position.positions.set(top_entity, @math.Vec2D(base_x, base_y))
  let top_text = "â•­â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®"
  let top_sprite = @sprite.Sprite::from_text(
    @sprite.Text::new(top_text, font="10px ThaleahFat", color="#222222"),
    UI_Z + 100,
  )
  @sprite.sprites.set(top_entity, top_sprite)
  dialogue_entities.push(top_entity)

  // èƒŒæ™¯è¡Œï¼ˆå‡å°‘åˆ°2è¡Œï¼‰
  let bg_text = "â”‚            â”‚"
  for i = 0; i < 2; i = i + 1 {
    let bg_entity = @system.Entity::new()
    @position.positions.set(bg_entity, @math.Vec2D(base_x, base_y + 12.0 + i.to_double() * 12.0))
    let bg_sprite = @sprite.Sprite::from_text(
      @sprite.Text::new(bg_text, font="10px ThaleahFat", color="#F8F8FF"),
      UI_Z + 100,
    )
    @sprite.sprites.set(bg_entity, bg_sprite)
    dialogue_entities.push(bg_entity)
  }

  // åº•éƒ¨è¾¹æ¡†ï¼ˆç¼©çŸ­ï¼‰
  let bottom_entity = @system.Entity::new()
  @position.positions.set(bottom_entity, @math.Vec2D(base_x, base_y + 36.0))
  let bottom_text = "â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯"
  let bottom_sprite = @sprite.Sprite::from_text(
    @sprite.Text::new(bottom_text, font="10px ThaleahFat", color="#222222"),
    UI_Z + 100,
  )
  @sprite.sprites.set(bottom_entity, bottom_sprite)
  dialogue_entities.push(bottom_entity)

  // å¤´åƒï¼ˆå¦‚æœæä¾›ï¼‰- ç¼©å°å°ºå¯¸
  match avatar_animation {
    Some(animation) => {
      let avatar_entity = @system.Entity::new()
      @position.positions.set(avatar_entity, @math.Vec2D(base_x + 4.0, base_y + 14.0))
      let avatar_sprite = @sprite.Sprite::from_animation(animation, UI_Z + 101)
      @sprite.sprites.set(avatar_entity, avatar_sprite)
      dialogue_entities.push(avatar_entity)
    }
    None => ()
  }

  // è§’è‰²åå­—ï¼ˆç¼©å°å­—ä½“ï¼‰
  let name_entity = @system.Entity::new()
  @position.positions.set(name_entity, @math.Vec2D(base_x + 30.0, base_y + 14.0))
  let name_sprite = @sprite.Sprite::from_text(
    @sprite.Text::new("ã€\{name}ã€‘", font="9px ThaleahFat", color="#FFD700"),
    UI_Z + 102,
  )
  @sprite.sprites.set(name_entity, name_sprite)
  dialogue_entities.push(name_entity)

  // å¯¹è¯æ–‡æœ¬ï¼ˆç¼©å°å­—ä½“å’Œä½ç½®ï¼‰
  let text_entity = @system.Entity::new()
  @position.positions.set(text_entity, @math.Vec2D(base_x + 8.0, base_y + 26.0))
  let text_sprite = @sprite.Sprite::from_text(
    @sprite.Text::new(text, font="8px ThaleahFat", color="#333333"),
    UI_Z + 102,
  )
  @sprite.sprites.set(text_entity, text_sprite)
  dialogue_entities.push(text_entity)

  println("âœ… å¯¹è¯æ¡†åˆ›å»ºå®Œæˆï¼Œå®ä½“æ•°é‡: \{dialogue_entities.length()}")
}
