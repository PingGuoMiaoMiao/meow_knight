// Cat çš„10ä¸ªåŠ¨ç”»çŠ¶æ€
let cat_idle_animation : @sprite.Animation = @sprite.Animation::new(
  @sprite.frames_from_atlas(
    "asserts1/Cats/cat_sprite_sheet.png",
    4,  // ç¬¬ä¸€ä¸ªåŠ¨ç”»ï¼šidle
    width=32,
    height=32,
    offset=@math.Vec2D(0.0, 0.0)  // ç¬¬ä¸€è¡Œ
  ),
  loop_=true,
  fps=8,
)

let cat_walk_right_animation : @sprite.Animation = @sprite.Animation::new(
  @sprite.frames_from_atlas(
    "asserts1/Cats/cat_sprite_sheet.png",
    4,  // ç¬¬äºŒä¸ªåŠ¨ç”»ï¼šå‘å³èµ°
    width=32,
    height=32,
    offset=@math.Vec2D(0.0, 32.0)  // ç¬¬äºŒè¡Œ
  ),
  loop_=true,
  fps=12,
)

let cat_angry_animation : @sprite.Animation = @sprite.Animation::new(
  @sprite.frames_from_atlas(
    "asserts1/Cats/cat_sprite_sheet.png",
    4,  // ç¬¬ä¸‰ä¸ªåŠ¨ç”»ï¼šç”Ÿæ°”
    width=32,
    height=32,
    offset=@math.Vec2D(0.0, 64.0)  // ç¬¬ä¸‰è¡Œ
  ),
  loop_=true,
  fps=10,
)

let cat_wipe_eyes_animation : @sprite.Animation = @sprite.Animation::new(
  @sprite.frames_from_atlas(
    "asserts1/Cats/cat_sprite_sheet.png",
    4,  // ç¬¬å››ä¸ªåŠ¨ç”»ï¼šæŠ¹çœ¼ç›
    width=32,
    height=32,
    offset=@math.Vec2D(0.0, 96.0)  // ç¬¬å››è¡Œ
  ),
  loop_=true,
  fps=6,
)

let cat_happy_jump_animation : @sprite.Animation = @sprite.Animation::new(
  @sprite.frames_from_atlas(
    "asserts1/Cats/cat_sprite_sheet.png",
    8,  // ç¬¬äº”ä¸ªåŠ¨ç”»ï¼šå¼€å¿ƒçš„è·³
    width=32,
    height=32,
    offset=@math.Vec2D(0.0, 128.0)  // ç¬¬äº”è¡Œ
  ),
  loop_=true,
  fps=14,
)

let cat_run_jump_animation : @sprite.Animation = @sprite.Animation::new(
  @sprite.frames_from_atlas(
    "asserts1/Cats/cat_sprite_sheet.png",
    8,  // ç¬¬å…­ä¸ªåŠ¨ç”»ï¼šè·‘ç€è·³
    width=32,
    height=32,
    offset=@math.Vec2D(0.0, 160.0)  // ç¬¬å…­è¡Œ
  ),
  loop_=true,
  fps=16,
)

let cat_sleep_animation : @sprite.Animation = @sprite.Animation::new(
  @sprite.frames_from_atlas(
    "asserts1/Cats/cat_sprite_sheet.png",
    4,  // ç¬¬ä¸ƒä¸ªåŠ¨ç”»ï¼šsleep
    width=32,
    height=32,
    offset=@math.Vec2D(0.0, 192.0)  // ç¬¬ä¸ƒè¡Œ
  ),
  loop_=true,
  fps=4,
)

let cat_happy_walk_animation : @sprite.Animation = @sprite.Animation::new(
  @sprite.frames_from_atlas(
    "asserts1/Cats/cat_sprite_sheet.png",
    6,  // ç¬¬å…«ä¸ªåŠ¨ç”»ï¼šå¼€å¿ƒçš„èµ°
    width=32,
    height=32,
    offset=@math.Vec2D(0.0, 224.0)  // ç¬¬å…«è¡Œ
  ),
  loop_=true,
  fps=10,
)

let cat_pounce_animation : @sprite.Animation = @sprite.Animation::new(
  @sprite.frames_from_atlas(
    "asserts1/Cats/cat_sprite_sheet.png",
    7,  // ç¬¬ä¹ä¸ªåŠ¨ç”»ï¼šæ‰‘å‘ä½ çš„è·³
    width=32,
    height=32,
    offset=@math.Vec2D(0.0, 256.0)  // ç¬¬ä¹è¡Œ
  ),
  loop_=false,  // æ‰‘è·³åŠ¨ç”»ä¸å¾ªç¯
  fps=18,
)

let cat_fluffy_angry_animation : @sprite.Animation = @sprite.Animation::new(
  @sprite.frames_from_atlas(
    "asserts1/Cats/cat_sprite_sheet.png",
    8,  // ç¬¬åä¸ªåŠ¨ç”»ï¼šç‚¸æ¯›
    width=32,
    height=32,
    offset=@math.Vec2D(0.0, 288.0)  // ç¬¬åè¡Œ
  ),
  loop_=true,
  fps=12,
)


let cats : Map[@system.Entity, Cat] = Map::new()

///|
const CAT_SPEED = 12.0
const CAT_GRAVITY = 1800.0  // Cat çš„é‡åŠ›åŠ é€Ÿåº¦

enum CatState {
  Idle          // å¾…æœº
  WalkRight     // å‘å³èµ°
  Angry         // ç”Ÿæ°”
  WipeEyes      // æŠ¹çœ¼ç›
  HappyJump     // å¼€å¿ƒçš„è·³
  RunJump       // è·‘ç€è·³
  Sleep         // ç¡è§‰
  HappyWalk     // å¼€å¿ƒçš„èµ°
  Pounce        // æ‰‘å‘ç©å®¶
  FluffyAngry   // ç‚¸æ¯›
}

struct Cat{
  health : Int
  speed : Double
  mut direction : Direction2
  mut is_hurt : Bool
  mut hurt_timer : Double
  mut state : CatState
  mut idle_timer : Double
  mut state_timer : Double    // çŠ¶æ€æŒç»­æ—¶é—´
  mut mood : Int             // å¿ƒæƒ…å€¼ï¼š0-100ï¼Œå½±å“è¡Œä¸º
  mut interaction_count : Int // ä¸ç©å®¶äº¤äº’æ¬¡æ•°
}


fn add_cat(pos : @math.Vec2D) -> Unit{
  println("ğŸ± Creating cat entity at position: \{pos}")
  let entity = @system.Entity::new()
  let cat_sprite = @sprite.Sprite::from_animation(
    cat_idle_animation, 10,
  )
  @sprite.sprites.set(entity, cat_sprite)
  @velocity.velocities.set(entity, @math.Vec2D::zero())
  @position.positions.set(entity, pos)
  
  println("ğŸ± Cat entity components set")
  
  // Cat éœ€è¦ç¢°æ’ä½“ç§¯æ¥ç«™åœ¨åœ°é¢ä¸Šï¼Œä½†ä¸ä¼šé˜»æŒ¡ç©å®¶
  @collision.shapes.set(
    entity,
    Rect(size=@math.Vec2D(32.0, 32.0), offset=@math.Vec2D(0.0, 0.0)),
  )
  @collision.collision_layers.set(entity, cat_collision_layer)  // ä½¿ç”¨ç‹¬ç«‹çš„ cat å±‚
  @collision.colliders.set(
    entity,
    @collision.Collider::new(
      @collision.CollisionMask::new([terrain_collision_layer])  // åªä¸åœ°å½¢ç¢°æ’
    ),
  )
  
  // æ·»åŠ äº¤äº’åŒºåŸŸç”¨äºä¸ç©å®¶äº¤äº’
  let area = @collision.Area::new(
    @collision.CollisionMask::new([player_collision_layer])
  )
  @collision.areas.set(entity, area)
  
  cats[entity] = Cat::{
    health: 50,
    speed: CAT_SPEED,
    direction: Direction2::Right,
    is_hurt: false,
    hurt_timer: 0.0,
    state: CatState::Idle,
    idle_timer: 0.0,
    state_timer: 0.0,
    mood: 75,  // åˆå§‹å¿ƒæƒ…è‰¯å¥½
    interaction_count: 0,
  }
  
  println("ğŸ± Cat added successfully")
}


fn cat_ai_system(delta : Double) -> Unit{
  if cats.is_empty() {
    return  // æ²¡æœ‰ cat å°±ç›´æ¥è¿”å›
  }
  
  for e, cat in cats {
    guard e.is_alive() else { continue }
    
    // åº”ç”¨é‡åŠ›
    guard @velocity.velocities.get(e) is Some(velocity) else { continue }
    
    // è·å– cat ä½ç½®
    guard @position.positions.get(e) is Some(cat_pos) else { continue }
    
    // åº”ç”¨é‡åŠ›åˆ° Y è½´é€Ÿåº¦
    let mut new_velocity_y = velocity.0[Y]
    new_velocity_y += CAT_GRAVITY * delta
    
    // æ›´æ–°çŠ¶æ€è®¡æ—¶å™¨
    cat.state_timer += delta
    cat.idle_timer += delta
    
    // æ£€æµ‹ç©å®¶è·ç¦»
    let mut player_distance = 1000.0  // é»˜è®¤å¾ˆè¿œ
    let mut player_pos_opt : Option[@math.Vec2D] = None
    
    match @position.positions.get(game_state.player) {
      Some(player_pos) => {
        player_pos_opt = Some(player_pos.0)
        let dx = cat_pos.0[X] - player_pos.0[X]
        let dy = cat_pos.0[Y] - player_pos.0[Y]
        player_distance = dx * dx + dy * dy  // è·ç¦»çš„å¹³æ–¹
      }
      None => ()
    }
    
    // Cat çŠ¶æ€æœºï¼šæ ¹æ®è·ç¦»ã€å¿ƒæƒ…å’Œæ—¶é—´å†³å®šè¡Œä¸º
    let close_distance = 80.0 * 80.0     // è¿‘è·ç¦»
    let medium_distance = 150.0 * 150.0  // ä¸­è·ç¦»
    
    // çŠ¶æ€è½¬æ¢é€»è¾‘
    match cat.state {
      CatState::Idle => {
        if player_distance < close_distance {
          // ç©å®¶é è¿‘ï¼Œæ ¹æ®å¿ƒæƒ…å†³å®šååº”
          if cat.mood > 60 {
            cat.state = CatState::HappyWalk
            cat.interaction_count += 1
          } else if cat.mood < 30 {
            cat.state = CatState::FluffyAngry
          } else {
            cat.state = CatState::WalkRight
          }
          cat.state_timer = 0.0
        } else if cat.idle_timer > 5.0 {
          cat.state = CatState::Sleep
          cat.state_timer = 0.0
        } else if cat.state_timer > 3.0 {
          // éšæœºé€‰æ‹©ä¸€ä¸ªåŠ¨ä½œ
          let random_action = (cat.state_timer * 17.0).to_int() % 4
          match random_action {
            0 => cat.state = CatState::WipeEyes
            1 => cat.state = CatState::HappyJump
            2 => cat.state = CatState::Angry
            _ => cat.state = CatState::WalkRight
          }
          cat.state_timer = 0.0
        }
      }
      
      CatState::WalkRight => {
        if cat.state_timer > 2.0 {
          cat.state = CatState::Idle
          cat.state_timer = 0.0
        }
      }
      
      CatState::HappyWalk => {
        if player_distance > medium_distance {
          cat.state = CatState::Idle
          cat.state_timer = 0.0
        } else if cat.state_timer > 1.5 && player_distance < close_distance {
          cat.state = CatState::Pounce  // æ‰‘å‘ç©å®¶
          cat.state_timer = 0.0
        }
      }
      
      CatState::Pounce => {
        if cat.state_timer > 1.0 {  // æ‰‘è·³åŠ¨ç”»å®Œæˆ
          cat.state = CatState::HappyJump
          cat.mood += 10  // å¿ƒæƒ…å˜å¥½
          cat.state_timer = 0.0
        }
      }
      
      CatState::FluffyAngry => {
        if cat.state_timer > 2.0 {
          if player_distance > medium_distance {
            cat.state = CatState::Idle
            cat.mood += 5  // ç©å®¶ç¦»å¼€åæƒ…ç»ªå¥½è½¬
          } else {
            cat.state = CatState::Angry
          }
          cat.state_timer = 0.0
        }
      }
      
      CatState::Sleep => {
        cat.idle_timer = 0.0  // é‡ç½®idleè®¡æ—¶å™¨
        if player_distance < close_distance {
          cat.state = CatState::WipeEyes  // è¢«å”¤é†’ï¼Œæ‰çœ¼ç›
          cat.state_timer = 0.0
        }
      }
      
      _ => {
        // å…¶ä»–çŠ¶æ€åœ¨ä¸€å®šæ—¶é—´åå›åˆ°Idle
        if cat.state_timer > 2.0 {
          cat.state = CatState::Idle
          cat.state_timer = 0.0
        }
      }
    }
    
    // æ ¹æ®çŠ¶æ€æ‰§è¡ŒåŠ¨ç”»å’Œç§»åŠ¨
    match cat.state {
      CatState::Idle => {
        @velocity.velocities[e] = @math.Vec2D(0.0, new_velocity_y)
        @sprite.play_animation(e, cat_idle_animation, transform=@math.Transform::new())
      }
      
      CatState::WalkRight => {
        let velocity_x = cat.speed * 0.5  // æ…¢æ…¢èµ°
        @velocity.velocities[e] = @math.Vec2D(velocity_x, new_velocity_y)
        @sprite.play_animation(e, cat_walk_right_animation, transform=@math.Transform::new())
      }
      
      CatState::HappyWalk => {
        let velocity_x = cat.speed * 0.7  // å¼€å¿ƒåœ°èµ°å¿«ä¸€ç‚¹
        @velocity.velocities[e] = @math.Vec2D(velocity_x, new_velocity_y)
        @sprite.play_animation(e, cat_happy_walk_animation, transform=@math.Transform::new())
      }
      
      CatState::Pounce => {
        // æ‰‘å‘ç©å®¶
        match player_pos_opt {
          Some(player_pos) => {
            let dx = player_pos[X] - cat_pos.0[X]
            let pounce_speed = if dx > 0.0 { cat.speed * 1.5 } else { -cat.speed * 1.5 }
            @velocity.velocities[e] = @math.Vec2D(pounce_speed, new_velocity_y - 200.0)  // è·³èµ·æ¥
          }
          None => @velocity.velocities[e] = @math.Vec2D(0.0, new_velocity_y)
        }
        @sprite.play_animation(e, cat_pounce_animation, transform=@math.Transform::new())
      }
      
      CatState::HappyJump => {
        @velocity.velocities[e] = @math.Vec2D(0.0, new_velocity_y)
        @sprite.play_animation(e, cat_happy_jump_animation, transform=@math.Transform::new())
      }
      
      CatState::RunJump => {
        let velocity_x = cat.speed * 1.2  // è·‘è·³
        @velocity.velocities[e] = @math.Vec2D(velocity_x, new_velocity_y)
        @sprite.play_animation(e, cat_run_jump_animation, transform=@math.Transform::new())
      }
      
      CatState::Sleep => {
        @velocity.velocities[e] = @math.Vec2D(0.0, new_velocity_y)
        @sprite.play_animation(e, cat_sleep_animation, transform=@math.Transform::new())
      }
      
      CatState::Angry => {
        @velocity.velocities[e] = @math.Vec2D(0.0, new_velocity_y)
        @sprite.play_animation(e, cat_angry_animation, transform=@math.Transform::new())
      }
      
      CatState::FluffyAngry => {
        @velocity.velocities[e] = @math.Vec2D(0.0, new_velocity_y)
        @sprite.play_animation(e, cat_fluffy_angry_animation, transform=@math.Transform::new())
      }
      
      CatState::WipeEyes => {
        @velocity.velocities[e] = @math.Vec2D(0.0, new_velocity_y)
        @sprite.play_animation(e, cat_wipe_eyes_animation, transform=@math.Transform::new())
      }
    }
    
    // å¿ƒæƒ…è‡ªç„¶æ¢å¤
    if cat.state_timer > 10.0 {
      if cat.mood < 50 {
        cat.mood += 1
      }
    }
  }
}