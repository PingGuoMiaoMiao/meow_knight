///|
fn tile_to_vec2d(tile : @tilemap.Tile, tile_size : Int) -> @math.Vec2D {
  @math.Vec2D(
    tile.x.to_double() * tile_size.to_double(),
    tile.y.to_double() * tile_size.to_double(),
  )
}

///|
struct UnknownBlock {
  entity : @system.Entity
  original_pos : @math.Vec2D
  mut is_moving : Bool
  mut move_timer : Double
  mut current_phase : Int // 0=åŸä½, 1=å‘ä¸Šç§»åŠ¨, 2=åœç•™, 3=å‘ä¸‹ç§»åŠ¨
}

///|
let unknown_blocks : Map[@system.Entity, UnknownBlock] = Map::new()

///|
let coins : Map[@system.Entity, Bool] = Map::new()  // å­˜å‚¨æ‰€æœ‰é‡‘å¸å®ä½“

fn add_Unknown(pos : @math.Vec2D, sprite_id : String) -> Unit {
  let src_pos: @math.Vec2D = match sprite_id {
    "43" => @math.Vec2D(16.0 * 4, 16.0 * 5)
    "44" => @math.Vec2D(16.0 * 3, 16.0 * 5)
    _ => panic()
  }
  let sprite = @sprite.Sprite::from_animation(
    @sprite.Animation::single_frame(
      "sprite_fusion/spritesheet.png",
      @math.Vec2D(16.0, 16.0),
      offset=src_pos,
    ),
    10,
  )
  let unknown = @system.Entity::new()
  @sprite.sprites.set(unknown, sprite)
  @position.positions.set(unknown, pos)
  // ç§»é™¤ç¢°æ’ä½“ç§¯ - Unknown blocks ç°åœ¨æ˜¯è£…é¥°æ€§çš„
  
  // æ³¨å†Œåˆ°Unknownå—ç®¡ç†ç³»ç»Ÿ
  unknown_blocks[unknown] = UnknownBlock::{
    entity: unknown,
    original_pos: pos,
    is_moving: false,
    move_timer: 0.0,
    current_phase: 0
  }
}

fn add_platform(pos : @math.Vec2D, sprite_id : String) -> Unit {
  let src_pos: @math.Vec2D = match sprite_id {
    "27" => @math.Vec2D(16.0 * 3, 3 * 16.0)
    "28" => @math.Vec2D(16.0 * 4, 3 * 16.0)
    _ => panic()
  }
  let sprite = @sprite.Sprite::from_animation(
    @sprite.Animation::single_frame(
      "sprite_fusion/spritesheet.png",
      @math.Vec2D(16.0, 16.0),
      offset=src_pos,
    ),
    10,
  )
  let platform = @system.Entity::new()
  @sprite.sprites.set(platform, sprite)
  @position.positions.set(platform, pos)
  // ç§»é™¤ç¢°æ’ä½“ç§¯ - Platform ç°åœ¨æ˜¯è£…é¥°æ€§çš„
}

///|
fn add_grass(pos : @math.Vec2D, sprite_id : String) -> Unit {
  let src_pos = match sprite_id {
    "45" => @math.Vec2D(16.0 * 5, 16.0 * 5)
    "46" => @math.Vec2D(16.0 * 6, 16.0 * 5)
    _ => panic()
  }
  let sprite = @sprite.Sprite::from_animation(
    @sprite.Animation::single_frame(
      "sprite_fusion/spritesheet.png",
      @math.Vec2D(16.0, 16.0),
      offset=src_pos,
    ),
    10,
  )
  let grass = @system.Entity::new()
  @sprite.sprites.set(grass, sprite)
  @position.positions.set(grass, pos)
  @collision.shapes.set(
    grass,
    Rect(size=@math.Vec2D(16.0, 4.0), offset=@math.Vec2D(0.0, 0.0)),
  )
  @collision.collision_layers.set(grass, terrain_collision_layer)
}

///|
fn add_coin(pos : @math.Vec2D) -> Unit {
  let coin = @system.Entity::new()
  let coin_sprite = @sprite.Sprite::from_animation(
    @sprite.Animation::new(
      @sprite.frames_from_atlas(
        "asserts1/Coin/coin.png",
        12,
        width=16.0,
        height=16.0,
      ),
      loop_=true,
      fps=12,
    ),
    20,
  )
  @sprite.sprites.set(coin, coin_sprite)
  @position.positions.set(coin, pos)
  @collision.shapes.set(
    coin,
    Rect(size=@math.Vec2D(16.0, 16.0), offset=@math.Vec2D::zero()),
  )
  
  // å°†é‡‘å¸æ·»åŠ åˆ°é›†åˆä¸­ï¼Œç­‰å¾…ç©å®¶æŒ‰Eæ‹¾å–
  coins[coin] = true
}

///|
pub fn try_pickup_coin() -> Unit {
  // å¦‚æœæ²¡æœ‰é‡‘å¸ï¼Œç›´æ¥è¿”å›
  if coins.is_empty() {
    return
  }
  
  let player_pos = @position.positions.get(game_state.player).unwrap_or(@math.Vec2D::zero())
  let coins_to_remove : Array[@system.Entity] = []
  
  // éå†æ‰€æœ‰é‡‘å¸ï¼Œæ£€æŸ¥æ˜¯å¦åœ¨æ‹¾å–èŒƒå›´å†…
  coins.iter().each(fn(entry) {
    let coin = entry.0
    if @position.positions.contains(coin) {
      let coin_pos = @position.positions.get(coin).unwrap_or(@math.Vec2D::zero())
      
      // åªè®¡ç®—Xæ–¹å‘çš„è·ç¦»
      let dx = coin_pos.0[X] - player_pos.0[X]
      let distance_x = if dx < 0.0 { -dx } else { dx }
      
      // æ‹¾å–èŒƒå›´50åƒç´ 
      if distance_x <= 50.0 {
        // å¢åŠ åˆ†æ•°
        set_score(game_state.score + 10)
        // æ’­æ”¾éŸ³æ•ˆ
        @audio.play_audio("sounds/coin.wav")
        // é”€æ¯é‡‘å¸
        @system.Entity::destroy(coin)
        // æ ‡è®°ä»é›†åˆä¸­ç§»é™¤
        coins_to_remove.push(coin)
      }
    }
  })
  
  // ä»é›†åˆä¸­ç§»é™¤å·²æ”¶é›†çš„é‡‘å¸
  coins_to_remove.iter().each(fn(coin) { coins.remove(coin) })
}

fn add_sand(pos : @math.Vec2D, sprite_id : String) -> Unit {
  let src_pos: @math.Vec2D = match sprite_id {
    "30" => @math.Vec2D(16.0 * 6, 3 * 16.0)
    "31" => @math.Vec2D(16.0 * 7, 3 * 16.0)
    _ => panic()
  }
  let sprite = @sprite.Sprite::from_animation(
    @sprite.Animation::single_frame(
      "sprite_fusion/spritesheet.png",
      @math.Vec2D(16.0, 16.0),
      offset=src_pos,
    ),
    10,
  )
  let sand = @system.Entity::new()
  @sprite.sprites.set(sand, sprite)
  @position.positions.set(sand, pos)
  @collision.shapes.set(
    sand,
    Rect(size=@math.Vec2D(16.0, 16.0), offset=@math.Vec2D::zero()),
  )
  @collision.collision_layers.set(sand, terrain_collision_layer)
}

fn add_trees(pos : @math.Vec2D, sprite_id : String) -> Unit {
  let src_pos: @math.Vec2D = match sprite_id {
    "32" => @math.Vec2D(16.0 * 0, 4 * 16.0)
    "33" => @math.Vec2D(16.0 * 1, 4 * 16.0)
    "34" => @math.Vec2D(16.0 * 2, 4 * 16.0)
    "35" => @math.Vec2D(16.0 * 3, 4 * 16.0)
    "36" => @math.Vec2D(16.0 * 4, 4 * 16.0)
    "37" => @math.Vec2D(16.0 * 5, 4 * 16.0)
    "38" => @math.Vec2D(16.0 * 6, 4 * 16.0)
    "39" => @math.Vec2D(16.0 * 7, 4 * 16.0)
    "40" => @math.Vec2D(16.0 * 0, 5 * 16.0)
    "41" => @math.Vec2D(16.0 * 1, 5 * 16.0)
    "42" => @math.Vec2D(16.0 * 2, 5 * 16.0)
    _ => panic()
  }
  let sprite = @sprite.Sprite::from_animation(
    @sprite.Animation::single_frame(
      "sprite_fusion/spritesheet.png",
      @math.Vec2D(16.0, 16.0),
      offset=src_pos,
    ),
    10,
  )
  let trees = @system.Entity::new()
  @sprite.sprites.set(trees, sprite)
  @position.positions.set(trees, pos)
  // trees ä¸éœ€è¦ç¢°æ’ä½“ç§¯ï¼Œåªæ˜¯è£…é¥°
}

fn add_stone(pos : @math.Vec2D, sprite_id : String) -> Unit {
  let src_pos: @math.Vec2D = match sprite_id {
    "20" => @math.Vec2D(16.0 * 4, 2 * 16.0)
    "21" => @math.Vec2D(16.0 * 5, 2 * 16.0)
    "22" => @math.Vec2D(16.0 * 6, 2 * 16.0)
    "23" => @math.Vec2D(16.0 * 7, 2 * 16.0)
    "24" => @math.Vec2D(16.0 * 0, 3 * 16.0)
    "25" => @math.Vec2D(16.0 * 1, 3 * 16.0)
    "26" => @math.Vec2D(16.0 * 2, 3 * 16.0)
    _ => panic()
  }
  let sprite = @sprite.Sprite::from_animation(
    @sprite.Animation::single_frame(
      "sprite_fusion/spritesheet.png",
      @math.Vec2D(16.0, 16.0),
      offset=src_pos,
    ),
    10,
  )
  let stone = @system.Entity::new()
  @sprite.sprites.set(stone, sprite)
  @position.positions.set(stone, pos)
  @collision.shapes.set(
    stone,
    Rect(size=@math.Vec2D(16.0, 16.0), offset=@math.Vec2D::zero()), 
  )
  @collision.collision_layers.set(stone, terrain_collision_layer)
}

///|
fn generate_map() -> Unit {
  let tilemap = @tilemap.TileMap::from_json(tilemap)
  let world_width = tilemap.map_width.to_double() * tilemap.tile_size.to_double()
  let world_height = tilemap.map_height.to_double() * tilemap.tile_size.to_double()
  
  // èƒŒæ™¯è£…é¥°å›¾ç‰‡å·²ç§»é™¤
  
  @camera.set_limits(top=0.0, bottom=world_height, left=0.0, right=world_width)
  
  // ç”Ÿæˆç©å®¶
  let role = tilemap.get_tiles_first("Role")[0]
  let player_pos = tile_to_vec2d(role, tilemap.tile_size)
  add_player(player_pos)
  println("ğŸ‘¤ ç©å®¶ä½ç½®: \{player_pos}")
  
  // ç”Ÿæˆåœ°å½¢
  let grasses = tilemap.get_tiles("Grass")
  for grass in grasses {
    add_grass(tile_to_vec2d(grass, tilemap.tile_size), grass.id)
  }
  
  let stones = tilemap.get_tiles("Stone")
  for stone in stones {
    add_stone(tile_to_vec2d(stone, tilemap.tile_size), stone.id)
  }
  
  let sands = tilemap.get_tiles("Sand")
  for sand in sands {
    add_sand(tile_to_vec2d(sand, tilemap.tile_size), sand.id)
  }
  
  let platforms = tilemap.get_tiles("Platform")
  for platform in platforms {
    add_platform(tile_to_vec2d(platform, tilemap.tile_size), platform.id)
  }
  
  let trees = tilemap.get_tiles("Trees")
  for tree in trees {
    add_trees(tile_to_vec2d(tree, tilemap.tile_size), tree.id)
  }
  
  let unknowns = tilemap.get_tiles("Unknown")
  for unknown in unknowns {
    add_Unknown(tile_to_vec2d(unknown, tilemap.tile_size), unknown.id)
  }
  
  // ç”Ÿæˆé‡‘å¸
  let coin_tiles = tilemap.get_tiles("Coin")
  for coin in coin_tiles {
    add_coin(tile_to_vec2d(coin, tilemap.tile_size))
  }
  
  // ç”Ÿæˆæ•Œäºº - ä¸´æ—¶å°†å®ƒä»¬æ”¾åœ¨ç©å®¶é™„è¿‘ä¾¿äºæµ‹è¯•
  let olders = tilemap.get_tiles("Older")
  if !olders.is_empty() {
    let pos = tile_to_vec2d(olders[0], tilemap.tile_size)
    println("ğŸ‘´ æ·»åŠ  Olderï¼Œæ”¾åœ¨ stone ä¸Šé¢")
    add_Older(@math.Vec2D(pos[X] + 200.0, 400.0 - 96.0))  // 400æ˜¯stoneçš„Yä½ç½®ï¼Œ96æ˜¯Olderçš„é«˜åº¦
  }

  let sprites_tiles = tilemap.get_tiles("Sprites")
  if !sprites_tiles.is_empty() {
    let pos = tile_to_vec2d(sprites_tiles[0], tilemap.tile_size)
    println("ğŸ­ æ·»åŠ  Sprite (é£è¡Œç²¾çµ)ï¼ŒåŸå§‹ä½ç½®: \{pos}ï¼Œè°ƒæ•´åˆ°ç©ºä¸­")
    add_sprite(@math.Vec2D(180.0, 50.0), "Hello!")  // é£åœ¨ç©ºä¸­ï¼ŒY=50ï¼Œåœ¨ slime å³ä¸Šæ–¹
  } else {
    println("âš ï¸ åœ°å›¾ä¸­æ²¡æœ‰æ‰¾åˆ° Sprites å›¾å±‚")
  }

  let mushrooms = tilemap.get_tiles("Mushroom")
  if !mushrooms.is_empty() {
    let pos = tile_to_vec2d(mushrooms[0], tilemap.tile_size)
    println("ğŸ„ æ·»åŠ  Mushroomï¼ŒåŸå§‹ä½ç½®: \{pos}ï¼Œè°ƒæ•´åˆ° slime é™„è¿‘")
    add_mushroom(@math.Vec2D(120.0, 0.0))  // æ”¾åœ¨ slime å·¦è¾¹ï¼Œä»é¡¶éƒ¨è½ä¸‹
  } else {
    println("âš ï¸ åœ°å›¾ä¸­æ²¡æœ‰æ‰¾åˆ° Mushroom å›¾å±‚")
  }

  let slimes = tilemap.get_tiles("Slime")
  if !slimes.is_empty() {
    // æŠŠ slime æ”¾åœ¨è‰åœ°ä¸Š (y=5çš„ä½ç½®ï¼Œä¹Ÿå°±æ˜¯80åƒç´ ï¼Œè®©å®ƒè‡ªç”±è½ä¸‹)
    add_silme(@math.Vec2D(150.0, 0.0))  // ä»é¡¶éƒ¨è½ä¸‹ï¼Œé‡åŠ›ä¼šè®©å®ƒç«™åœ¨ grass ä¸Š
  }

  let cats = tilemap.get_tiles("Cat")
  if !cats.is_empty() {
    // ä»åœ°å›¾ä¸­è¯»å– Cat çš„ä½ç½®å¹¶æ·»åŠ 
    let pos = tile_to_vec2d(cats[0], tilemap.tile_size)
    println("ğŸ± æ·»åŠ  Catï¼ŒåŸå§‹ä½ç½®: \{pos}")
    // æŠŠ cat æ”¾åœ¨ç©å®¶å³ä¾§ 80 åƒç´ çš„ä½ç½®
    add_cat(@math.Vec2D(player_pos[X] + 80.0, player_pos[Y]))
  } else {
    println("âš ï¸ åœ°å›¾ä¸­æ²¡æœ‰æ‰¾åˆ° Cat å›¾å±‚")
  }
}