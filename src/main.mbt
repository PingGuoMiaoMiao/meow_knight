///|
const ZOOM : Double = 2.0

const World_Width : Double = 500.0

const World_Height : Double = 600.0

///|
fn main {
  @system.App::new()
  .with_canvas_width(World_Width)
  .with_canvas_height(World_Height)
  .with_image_smooth(false)
  .with_fps(120)
  .with_zoom(ZOOM)
  .add_plugin(@plugins.default_plugin)
  .add_system(game_start, schedule=Startup)
  .add_system(dialogue_input_system)
  .add_system(player_state_system)
  .add_system(player_collision_system)
  .add_system(skeleton_ai_system)
  .add_system(older_ai_system)
  .add_system(mushroom_ai_system)
  .add_system(silme_ai_system)
  .add_system(cat_ai_system)
  .add_system(sprite_ai_system)
  .add_system(scene_transition_system)  // æ·»åŠ åœºæ™¯åˆ‡æ¢æ£€æµ‹ç³»ç»Ÿ
  .run()
}

///|
fn game_start(_delta : Double) -> Unit {
  generate_map()
  
  // æ·»åŠ ç®€åŒ–çš„UIå…ƒç´ 
  add_score_box()
  add_health_box()
  add_volume_button()
}

///| å¯¹è¯æ¡†è¾“å…¥ç³»ç»Ÿ - ç›‘å¬ç©ºæ ¼é”®åˆ‡æ¢å¯¹è¯æˆ–å…³é—­å¯¹è¯æ¡†
fn dialogue_input_system(_delta : Double) -> Unit {
  if is_dialogue_showing() {
    // æ£€æŸ¥ç©ºæ ¼é”®æ˜¯å¦è¢«æŒ‰ä¸‹
    if @inputs.is_just_pressed(@inputs.Space) {
      // å¦‚æžœæœ‰å¯¹è¯é˜Ÿåˆ—ï¼Œæ˜¾ç¤ºä¸‹ä¸€æ®µ
      if has_dialogue_queue() {
        show_next_dialogue()
        println("âž¡ï¸ æ˜¾ç¤ºä¸‹ä¸€æ®µå¯¹è¯")
      } else {
        // æ²¡æœ‰é˜Ÿåˆ—ï¼Œç›´æŽ¥å…³é—­
        clear_dialogue()
        println("ðŸšª å¯¹è¯æ¡†å·²å…³é—­ï¼ˆç©ºæ ¼é”®ï¼‰")
      }
    }
  }
}

///| åœºæ™¯åˆ‡æ¢æ£€æµ‹ç³»ç»Ÿ - æ£€æŸ¥æ˜¯å¦æ‰€æœ‰ Older éƒ½è¢«å‡»è´¥äº†
fn scene_transition_system(_delta : Double) -> Unit {
  check_scene_transition()
}
