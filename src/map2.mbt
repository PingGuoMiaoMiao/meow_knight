// ç¬¬äºŒå…³åœ°å›¾ç®¡ç†
// è¿™é‡Œå®šä¹‰ç¬¬äºŒå…³çš„å¸ƒå±€ã€æ•Œäººé…ç½®å’Œç‰¹æ®Šæœºåˆ¶

///| ç¬¬äºŒå…³çš„æ•Œäººå®ä½“è¿½è¸ª
let level2_enemies : Map[@system.Entity, Bool] = Map::new()

///| åŠ è½½ç¬¬äºŒå…³
pub fn load_level2() -> Unit {
  println("ğŸšª æ­£åœ¨åŠ è½½ç¬¬äºŒå…³...")
  
  // é¦–å…ˆæ¸…é™¤å½“å‰åœºæ™¯çš„æ‰€æœ‰å®ä½“
  clear_current_scene()
  
  // é‡ç½®ç©å®¶ä½ç½®åˆ°ç¬¬äºŒå…³èµ·å§‹ç‚¹
  @position.positions.set(game_state.player, @math.Vec2D(50.0, 100.0))
  
  // åŠ è½½ç¬¬äºŒå…³èƒŒæ™¯
  setup_level2_background()
  
  // ç”Ÿæˆç¬¬äºŒå…³åœ°å½¢
  setup_level2_terrain()
  
  // æ·»åŠ ç¬¬äºŒå…³æ•Œäºº
  setup_level2_enemies()
  
  // æ·»åŠ ç¬¬äºŒå…³ç‰¹æ®Šç‰©å“
  setup_level2_items()
  
  println("âœ… ç¬¬äºŒå…³åŠ è½½å®Œæˆï¼")
}

///| è®¾ç½®ç¬¬äºŒå…³èƒŒæ™¯
fn setup_level2_background() -> Unit {
  let background = @system.Entity::new()
  let background_sprite = @sprite.Sprite::from_animation(
    @sprite.Animation::single_frame(
      "asserts1/Background/background2.png",  // ç¬¬äºŒå…³ä½¿ç”¨ä¸åŒçš„èƒŒæ™¯
      @math.Vec2D(1056.0, 432.0),
      offset=@math.Vec2D::zero(),
    ),
    0,
  )
  @sprite.sprites.set(background, background_sprite)
  @position.positions.set(background, @math.Vec2D::zero())
  
  println("ğŸ–¼ï¸ ç¬¬äºŒå…³èƒŒæ™¯è®¾ç½®å®Œæˆ")
}

///| è®¾ç½®ç¬¬äºŒå…³åœ°å½¢
fn setup_level2_terrain() -> Unit {
  // åˆ›å»ºä¸€ä¸ªæ›´æœ‰æŒ‘æˆ˜æ€§çš„åœ°å½¢å¸ƒå±€
  
  // å·¦ä¾§å¹³å°
  add_stone(@math.Vec2D(100.0, 350.0), "21")
  add_stone(@math.Vec2D(116.0, 350.0), "21")
  add_stone(@math.Vec2D(132.0, 350.0), "21")
  
  // ä¸­é—´é«˜å°
  add_stone(@math.Vec2D(250.0, 280.0), "21")
  add_stone(@math.Vec2D(266.0, 280.0), "21")
  add_stone(@math.Vec2D(282.0, 280.0), "21")
  add_stone(@math.Vec2D(298.0, 280.0), "21")
  
  // å³ä¾§å¹³å°
  add_stone(@math.Vec2D(450.0, 320.0), "21")
  add_stone(@math.Vec2D(466.0, 320.0), "21")
  add_stone(@math.Vec2D(482.0, 320.0), "21")
  
  // åº•éƒ¨åœ°é¢
  for i = 0; i < 15; i = i + 1 {
    add_stone(@math.Vec2D(16.0 * i.to_double(), 400.0), "21")
  }
  
  // æ·»åŠ ä¸€äº›è‰åœ°è£…é¥°
  add_grass(@math.Vec2D(100.0, 334.0), "46")  // å·¦ä¾§å¹³å°ä¸Šçš„è‰
  add_grass(@math.Vec2D(250.0, 264.0), "46")  // ä¸­é—´é«˜å°ä¸Šçš„è‰
  add_grass(@math.Vec2D(450.0, 304.0), "46")  // å³ä¾§å¹³å°ä¸Šçš„è‰
  
  println("ğŸ—» ç¬¬äºŒå…³åœ°å½¢è®¾ç½®å®Œæˆ")
}

///| è®¾ç½®ç¬¬äºŒå…³æ•Œäºº
fn setup_level2_enemies() -> Unit {
  // æ¸…ç©ºæ•Œäººè¿½è¸ªåˆ—è¡¨
  level2_enemies.clear()
  
  // æ·»åŠ æ›´å¤šæŒ‘æˆ˜æ€§çš„æ•Œäººç»„åˆ
  
  // å·¦ä¾§å¹³å°ï¼š1ä¸ªå²è±å§†
  add_silme(@math.Vec2D(120.0, 0.0))
  
  // ä¸­é—´é«˜å°ï¼š2ä¸ªè˜‘è‡æ€ª
  add_mushroom(@math.Vec2D(260.0, 0.0))
  add_mushroom(@math.Vec2D(290.0, 0.0))
  
  // å³ä¾§å¹³å°ï¼š1ä¸ªå²è±å§†
  add_silme(@math.Vec2D(460.0, 0.0))
  
  // æœ€ç»ˆBossï¼š2ä¸ªOlderï¼
  let older1 = add_Older(@math.Vec2D(350.0, 300.0))
  let older2 = add_Older(@math.Vec2D(400.0, 300.0))
  
  // å°†Olderæ³¨å†Œåˆ°åœºæ™¯åˆ‡æ¢ç³»ç»Ÿ
  older_entities.set(older1, true)
  older_entities.set(older2, true)
  
  println("ğŸ‘¹ ç¬¬äºŒå…³æ•Œäººè®¾ç½®å®Œæˆï¼š2ä¸ªOlder Bosséœ€è¦å‡»è´¥ï¼")
}

///| è®¾ç½®ç¬¬äºŒå…³ç‰©å“
fn setup_level2_items() -> Unit {
  // åœ¨å„ä¸ªå¹³å°æ”¾ç½®é‡‘å¸ä½œä¸ºå¥–åŠ±
  add_coin(@math.Vec2D(120.0, 300.0))  // å·¦ä¾§å¹³å°
  add_coin(@math.Vec2D(270.0, 230.0))  // ä¸­é—´é«˜å°
  add_coin(@math.Vec2D(460.0, 270.0))  // å³ä¾§å¹³å°
  add_coin(@math.Vec2D(375.0, 350.0))  // BossåŒºåŸŸé™„è¿‘
  
  println("ğŸ’° ç¬¬äºŒå…³ç‰©å“è®¾ç½®å®Œæˆ")
}

///| æ£€æŸ¥ç¬¬äºŒå…³æ˜¯å¦å®Œæˆ
pub fn check_level2_completion() -> Unit {
  // è¿™ä¸ªå‡½æ•°å¯ä»¥æ£€æŸ¥ç¬¬äºŒå…³çš„å®Œæˆæ¡ä»¶
  // æ¯”å¦‚å‡»è´¥æ‰€æœ‰Bossã€æ”¶é›†æ‰€æœ‰ç‰©å“ç­‰
  if !older_entities.is_empty() {
    let all_bosses_defeated = older_entities.iter().all(fn(entry) {
      let boss_entity = entry.0
      !@position.positions.contains(boss_entity)
    })
    
    if all_bosses_defeated {
      println("ğŸ† æ­å–œï¼ä½ å·²ç»é€šå…³äº†æ‰€æœ‰å…³å¡ï¼")
      // å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ é€šå…³åŠ¨ç”»æˆ–è¿”å›ä¸»èœå•çš„é€»è¾‘
    }
  }
}